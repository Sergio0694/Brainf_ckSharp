<UserControl
    x:Class="Brainf_ckSharp.Uwp.Controls.Host.Shell"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:markupExtensions="using:Brainf_ckSharp.Uwp.MarkupExtensions"
    xmlns:toolkitExtensions="using:Microsoft.Toolkit.Uwp.UI.Extensions"
    xmlns:controls="using:Brainf_ckSharp.Uwp.Controls.Windows.UI.Xaml.Controls"
    xmlns:views="using:Brainf_ckSharp.Uwp.Views"
    xmlns:shellHeader="using:Brainf_ckSharp.Uwp.Controls.Host.Header"
    xmlns:inputPanel="using:Brainf_ckSharp.Uwp.Controls.Host.InputPanel"
    xmlns:host="using:Brainf_ckSharp.Uwp.Controls.SubPages.Host"
    xmlns:attachedProperties="using:Brainf_ckSharp.Uwp.AttachedProperties"
    xmlns:converters="using:Brainf_ckSharp.Uwp.Converters"
    xmlns:local="using:Brainf_ckSharp.Uwp.Controls.Host"
    xmlns:settings="using:Brainf_ckSharp.Shared.Enums.Settings"
    mc:Ignorable="d"
    d:DesignHeight="600"
    d:DesignWidth="400"
    Loaded="Shell_OnLoaded">
    <UserControl.Resources>

        <!--Converter for the two way binding. This is needed because x:Bind
            doesn't support static functions being used for two way binding yet.
            Not using a converter results in the convert back value being discarded.-->
        <converters:PivotSelectionConverter x:Key="PivotSelectionConverter"/>
    </UserControl.Resources>

    <!--Main app UI-->
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="68"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="24"/>
        </Grid.RowDefinitions>

        <!--Console and IDE-->
        <Pivot
            Grid.Row="0"
            Grid.RowSpan="2"
            Style="{StaticResource ExpandedPivotWithNoHeaderStyle}"
            SelectedIndex="{x:Bind converters:PivotSelectionConverter.ConvertToIndex(ViewModel.SelectedView), Mode=OneWay}">
            <PivotItem>
                <views:ConsoleView attachedProperties:ObservableRecipientHelper.IsActive="{x:Bind ViewModel.SelectedView.Equals(settings:ViewType.Console), Mode=OneWay}"/>
            </PivotItem>
            <PivotItem>
                <views:IdeView attachedProperties:ObservableRecipientHelper.IsActive="{x:Bind ViewModel.SelectedView.Equals(settings:ViewType.Ide), Mode=OneWay}"/>
            </PivotItem>
        </Pivot>

        <!--Header drop shadow-->
        <Rectangle
            Grid.Row="1"
            VerticalAlignment="Top"
            IsHitTestVisible="False"
            Height="8">
            <Rectangle.Fill>
                <LinearGradientBrush EndPoint="0,0" StartPoint="0,1">
                    <GradientStop Color="#60000000" Offset="1"/>
                    <GradientStop Offset="0"/>
                </LinearGradientBrush>
            </Rectangle.Fill>
        </Rectangle>

        <!--Header panel-->
        <shellHeader:HeaderPanel
            Grid.Row="0"
            SelectedIndex="{x:Bind ViewModel.SelectedView, Converter={StaticResource PivotSelectionConverter}, Mode=TwoWay}"/>

        <!--Expandable keyboard area-->
        <Border
            Grid.Row="2"
            BorderThickness="0,1,0,0"
            BorderBrush="#FF323232"
            Background="{StaticResource VirtualKeyboardBackgroundBrush}">
            <controls:ExpanderControl
                HeaderHeight="48"
                ExpandableContentHeight="180"
                IsExpanded="{x:Bind ViewModel.IsVirtualKeyboardEnabled, Mode=TwoWay}">
                <controls:ExpanderControl.Header>
                    <inputPanel:StdinHeader
                        x:Name="StdinHeader"
                        ShellSelectedIndex="{x:Bind converters:PivotSelectionConverter.ConvertToIndex(ViewModel.SelectedView), Mode=OneWay}"/>
                </controls:ExpanderControl.Header>
                <controls:ExpanderControl.ExpandableContent>
                    <controls:LockedPivot
                        Style="{StaticResource ExpandedPivotWithNoHeaderStyle}"
                        SelectedIndex="{x:Bind StdinHeader.StdinSelectedIndex, Mode=OneWay, FallbackValue=0}"
                        SelectionChanged="Pivot_OnSelectionChanged">
                        <PivotItem>
                            <inputPanel:VirtualKeyboard/>
                        </PivotItem>
                        <PivotItem>
                            <inputPanel:CompactMemoryViewer/>
                        </PivotItem>
                    </controls:LockedPivot>
                </controls:ExpanderControl.ExpandableContent>
            </controls:ExpanderControl>
        </Border>

        <!--Command bar-->
        <controls:AnimatedCommandBar
            Grid.Row="3"
            IsDynamicOverflowEnabled="False"
            Style="{StaticResource CommandBarRevealStyle}"
            IsPrimaryContentDisplayed="{x:Bind ViewModel.SelectedView.Equals(settings:ViewType.Console), Mode=OneWay}">
            <controls:AnimatedCommandBar.PrimaryCommands>

                <!--Console buttons-->
                <AppBarButton
                    x:Uid="Shell/Run"
                    Label="Run"
                    Icon="{toolkitExtensions:FontIcon Glyph={StaticResource RunIcon}}"
                    Tag="{markupExtensions:Boolean Value=True}"
                    Foreground="{StaticResource RunBrush}"
                    Click="{x:Bind ViewModel.RunConsoleScript}">
                    <AppBarButton.Resources>
                        <SolidColorBrush x:Key="AppBarButtonForegroundPointerOver" Color="{StaticResource RunColor}"/>
                        <SolidColorBrush x:Key="AppBarButtonForegroundPressed" Color="{StaticResource RunColor}"/>
                    </AppBarButton.Resources>
                    <AppBarButton.KeyboardAccelerators>
                        <KeyboardAccelerator Key="F5"/>
                    </AppBarButton.KeyboardAccelerators>
                </AppBarButton>
                <AppBarButton
                    x:Uid="Shell/Delete"
                    Label="Delete"
                    Icon="{toolkitExtensions:FontIcon Glyph={StaticResource DeleteKeyIcon}}"
                    Tag="{markupExtensions:Boolean Value=True}"
                    Click="{x:Bind ViewModel.DeleteConsoleOperator}">
                    <AppBarButton.KeyboardAccelerators>
                        <KeyboardAccelerator Key="Back"/>
                    </AppBarButton.KeyboardAccelerators>
                </AppBarButton>
                <AppBarButton
                    x:Uid="Shell/Clear"
                    Label="Clear"
                    Icon="{toolkitExtensions:FontIcon Glyph={StaticResource ClearIcon}}"
                    Tag="{markupExtensions:Boolean Value=True}"
                    Click="{x:Bind ViewModel.ClearConsoleCommand}">
                    <AppBarButton.KeyboardAccelerators>
                        <KeyboardAccelerator Key="Delete" Modifiers="Control"/>
                    </AppBarButton.KeyboardAccelerators>
                </AppBarButton>

                <!--IDE buttons-->
                <AppBarButton
                    x:Uid="Shell/Run"
                    Label="Run"
                    Icon="{toolkitExtensions:FontIcon Glyph={StaticResource RunIcon}}"
                    Tag="{markupExtensions:Boolean Value=False}"
                    Foreground="{StaticResource RunBrush}"
                    Click="{x:Bind ViewModel.RunIdeScript}">
                    <AppBarButton.Resources>
                        <SolidColorBrush x:Key="AppBarButtonForegroundPointerOver" Color="{StaticResource RunColor}"/>
                        <SolidColorBrush x:Key="AppBarButtonForegroundPressed" Color="{StaticResource RunColor}"/>
                    </AppBarButton.Resources>
                </AppBarButton>
                <AppBarButton
                    x:Uid="Shell/Debug"
                    Label="Debug"
                    Icon="{toolkitExtensions:FontIcon Glyph={StaticResource DebugIcon}}"
                    Tag="{markupExtensions:Boolean Value=False}"
                    Foreground="{StaticResource DebugBrush}"
                    Click="{x:Bind ViewModel.DebugIdeScript}">
                    <AppBarButton.Resources>
                        <SolidColorBrush x:Key="AppBarButtonForegroundPointerOver" Color="{StaticResource DebugColor}"/>
                        <SolidColorBrush x:Key="AppBarButtonForegroundPressed" Color="{StaticResource DebugColor}"/>
                    </AppBarButton.Resources>
                </AppBarButton>
                <AppBarSeparator Tag="{markupExtensions:Boolean Value=False}"/>
                <AppBarButton
                    x:Uid="Shell/Move"
                    Label="Move"
                    Icon="{toolkitExtensions:FontIcon Glyph={StaticResource MoveIcon}}"
                    Tag="{markupExtensions:Boolean Value=False}">
                    <AppBarButton.Flyout>
                        <CommandBarFlyout>
                            <AppBarButton
                                x:Uid="Shell/Up"
                                Label="Up"
                                ToolTipService.ToolTip="Up"
                                Icon="{toolkitExtensions:FontIcon Glyph={StaticResource UpIcon}}"
                                Command="{x:Bind MoveCommand}"
                                CommandParameter="{markupExtensions:VirtualKey Value=Up}"/>
                            <AppBarButton
                                x:Uid="Shell/Down"
                                Label="Down"
                                ToolTipService.ToolTip="Down"
                                Icon="{toolkitExtensions:FontIcon Glyph={StaticResource DownIcon}}"
                                Command="{x:Bind MoveCommand}"
                                CommandParameter="{markupExtensions:VirtualKey Value=Down}"/>
                            <AppBarButton
                                x:Uid="Shell/Left"
                                Label="Left"
                                ToolTipService.ToolTip="Left"
                                Icon="{toolkitExtensions:FontIcon Glyph={StaticResource LeftIcon}}"
                                Command="{x:Bind MoveCommand}"
                                CommandParameter="{markupExtensions:VirtualKey Value=Left}"/>
                            <AppBarButton
                                x:Uid="Shell/Right"
                                Label="Right"
                                ToolTipService.ToolTip="Right"
                                Icon="{toolkitExtensions:FontIcon Glyph={StaticResource RightIcon}}"
                                Command="{x:Bind MoveCommand}"
                                CommandParameter="{markupExtensions:VirtualKey Value=Right}"/>
                        </CommandBarFlyout>
                    </AppBarButton.Flyout>
                </AppBarButton>
                <AppBarButton
                    x:Uid="Shell/NewLine"
                    Label="New line"
                    Icon="{toolkitExtensions:FontIcon Glyph={StaticResource NewLineIcon}}"
                    Tag="{markupExtensions:Boolean Value=False}"
                    Click="{x:Bind ViewModel.InsertNewLine}"/>
                <AppBarButton
                    x:Uid="Shell/Delete"
                    Label="Delete"
                    Icon="{toolkitExtensions:FontIcon Glyph={StaticResource DeleteKeyIcon}}"
                    Tag="{markupExtensions:Boolean Value=False}"
                    Click="{x:Bind ViewModel.DeleteIdeCharacter}"/>
                <AppBarButton
                    x:Uid="Shell/Undo"
                    Label="Undo"
                    Icon="{toolkitExtensions:FontIcon Glyph={StaticResource UndoIcon}}"
                    Tag="{markupExtensions:Boolean Value=False}"/>
                <AppBarButton
                    x:Uid="Shell/Redo"
                    Label="Redo"
                    Icon="{toolkitExtensions:FontIcon Glyph={StaticResource RedoIcon}}"
                    Tag="{markupExtensions:Boolean Value=False}"/>
            </controls:AnimatedCommandBar.PrimaryCommands>
            <controls:AnimatedCommandBar.SecondaryCommands>
                <AppBarButton
                    x:Uid="Shell/UserGuide"
                    Label="User guide"
                    Icon="{toolkitExtensions:FontIcon Glyph={StaticResource UserGuideIcon}}"
                    Click="{x:Bind ViewModel.RequestUserGuide}">
                    <AppBarButton.KeyboardAccelerators>
                        <KeyboardAccelerator Key="G" Modifiers="Control"/>
                    </AppBarButton.KeyboardAccelerators>
                </AppBarButton>
                <AppBarButton
                    x:Uid="Shell/UnicodeCharacters"
                    Label="Unicode characters"
                    Icon="{toolkitExtensions:FontIcon Glyph={StaticResource ShowUnicodeMapIcon}}"
                    Click="{x:Bind ViewModel.RequestUnicodeMap}">
                    <AppBarButton.KeyboardAccelerators>
                        <KeyboardAccelerator Key="U" Modifiers="Control"/>
                    </AppBarButton.KeyboardAccelerators>
                </AppBarButton>
                <AppBarSeparator/>
                <AppBarButton
                    x:Uid="Shell/RepeatLastScript"
                    Label="Repeat last script"
                    Icon="{toolkitExtensions:FontIcon Glyph={StaticResource RepeatScriptIcon}}"
                    Click="{x:Bind ViewModel.RepeatLastConsoleScript}"
                    Visibility="{x:Bind converters:PivotSelectionConverter.ConvertToVisibility(ViewModel.SelectedView, settings:ViewType.Console), Mode=OneWay}">
                    <AppBarButton.KeyboardAccelerators>
                        <KeyboardAccelerator
                            Key="F2" Modifiers="Control"
                            IsEnabled="{x:Bind ViewModel.SelectedView.Equals(settings:ViewType.Console), Mode=OneWay}"/>
                    </AppBarButton.KeyboardAccelerators>
                </AppBarButton>
                <AppBarButton
                    x:Uid="Shell/Restart"
                    Label="Restart"
                    Icon="{toolkitExtensions:FontIcon Glyph={StaticResource RestartIcon}}"
                    Click="{x:Bind ViewModel.RestartConsole}"
                    Visibility="{x:Bind converters:PivotSelectionConverter.ConvertToVisibility(ViewModel.SelectedView, settings:ViewType.Console), Mode=OneWay}">
                    <AppBarButton.KeyboardAccelerators>
                        <KeyboardAccelerator
                            Key="F6" Modifiers="Control"
                            IsEnabled="{x:Bind ViewModel.SelectedView.Equals(settings:ViewType.Console), Mode=OneWay}"/>
                    </AppBarButton.KeyboardAccelerators>
                </AppBarButton>
                <AppBarButton
                    x:Uid="Shell/ClearScreen"
                    Label="Clear screen"
                    Icon="{toolkitExtensions:FontIcon Glyph={StaticResource ClearScreen}}"
                    Click="{x:Bind ViewModel.ClearConsoleScreen}"
                    Visibility="{x:Bind converters:PivotSelectionConverter.ConvertToVisibility(ViewModel.SelectedView, settings:ViewType.Console), Mode=OneWay}">
                    <AppBarButton.KeyboardAccelerators>
                        <KeyboardAccelerator
                            Key="F4" Modifiers="Control"
                            IsEnabled="{x:Bind ViewModel.SelectedView.Equals(settings:ViewType.Console), Mode=OneWay}"/>
                    </AppBarButton.KeyboardAccelerators>
                </AppBarButton>
                <AppBarButton
                    x:Uid="Shell/NewFile"
                    Label="New file"
                    Icon="{toolkitExtensions:FontIcon Glyph={StaticResource NewFileIcon}}"
                    Visibility="{x:Bind converters:PivotSelectionConverter.ConvertToVisibility(ViewModel.SelectedView, settings:ViewType.Ide), Mode=OneWay}"
                    Click="{x:Bind ViewModel.NewIdeFile}"/>
                <AppBarSeparator Visibility="{x:Bind converters:PivotSelectionConverter.ConvertToVisibility(ViewModel.SelectedView, settings:ViewType.Ide), Mode=OneWay}"/>
                <AppBarButton
                    x:Uid="Shell/OpenCodeLibrary"
                    Label="Open code library"
                    Icon="{toolkitExtensions:FontIcon Glyph={StaticResource OpenCodeLibraryIcon}}"
                    Visibility="{x:Bind converters:PivotSelectionConverter.ConvertToVisibility(ViewModel.SelectedView, settings:ViewType.Ide), Mode=OneWay}"
                    Click="{x:Bind ViewModel.RequestCodeLibrary}"/>
                <AppBarButton
                    x:Uid="Shell/OpenFile"
                    Label="Open file"
                    Icon="{toolkitExtensions:FontIcon Glyph={StaticResource OpenFileIcon}}"
                    Visibility="{x:Bind converters:PivotSelectionConverter.ConvertToVisibility(ViewModel.SelectedView, settings:ViewType.Ide), Mode=OneWay}"
                    Click="{x:Bind ViewModel.OpenFile}"/>
                <AppBarSeparator Visibility="{x:Bind converters:PivotSelectionConverter.ConvertToVisibility(ViewModel.SelectedView, settings:ViewType.Ide), Mode=OneWay}"/>
                <AppBarButton
                    x:Uid="Shell/Save"
                    Label="Save"
                    Icon="{toolkitExtensions:FontIcon Glyph={StaticResource SaveIcon}}"
                    Visibility="{x:Bind converters:PivotSelectionConverter.ConvertToVisibility(ViewModel.SelectedView, settings:ViewType.Ide), Mode=OneWay}"
                    Click="{x:Bind ViewModel.SaveFile}">
                    <AppBarButton.KeyboardAccelerators>
                        <KeyboardAccelerator
                            Key="S" Modifiers="Control"
                            IsEnabled="{x:Bind ViewModel.SelectedView.Equals(settings:ViewType.Ide), Mode=OneWay}"/>
                    </AppBarButton.KeyboardAccelerators>
                </AppBarButton>
                <AppBarButton
                    x:Uid="Shell/SaveAs"
                    Label="Save as"
                    Icon="{toolkitExtensions:FontIcon Glyph={StaticResource SaveAsIcon}}"
                    Visibility="{x:Bind converters:PivotSelectionConverter.ConvertToVisibility(ViewModel.SelectedView, settings:ViewType.Ide), Mode=OneWay}"
                    Click="{x:Bind ViewModel.SaveFileAs}">
                    <AppBarButton.KeyboardAccelerators>
                        <KeyboardAccelerator
                            Key="S" Modifiers="Menu"
                            IsEnabled="{x:Bind ViewModel.SelectedView.Equals(settings:ViewType.Ide), Mode=OneWay}"/>
                    </AppBarButton.KeyboardAccelerators>
                </AppBarButton>
                <AppBarSeparator/>
                <AppBarButton
                    x:Uid="Shell/Settings"
                    Label="Settings"
                    Icon="{toolkitExtensions:FontIcon Glyph={StaticResource SettingsIcon}}"
                    Click="{x:Bind ViewModel.RequestSettings}">
                    <AppBarButton.KeyboardAccelerators>
                        <KeyboardAccelerator Key="I" Modifiers="Control"/>
                    </AppBarButton.KeyboardAccelerators>
                </AppBarButton>
                <AppBarButton
                    x:Uid="Shell/About"
                    Label="About"
                    Icon="{toolkitExtensions:FontIcon Glyph={StaticResource AboutIcon}}"
                    Click="{x:Bind ViewModel.RequestAboutInfo}">
                    <AppBarButton.KeyboardAccelerators>
                        <KeyboardAccelerator Key="A" Modifiers="Control"/>
                    </AppBarButton.KeyboardAccelerators>
                </AppBarButton>
            </controls:AnimatedCommandBar.SecondaryCommands>
        </controls:AnimatedCommandBar>

        <!--Status bar-->
        <local:StatusBar Grid.Row="4"/>

        <!--Sub page host-->
        <host:SubPageHost
            Grid.Row="0"
            Grid.RowSpan="5"/>
    </Grid>
</UserControl>
